<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat estilo WhatsApp</title>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
html, body { height:100%; font-family:"Segoe UI",Tahoma,Verdana,sans-serif; background:#e5ddd5; display:flex; justify-content:center; align-items:center; }

.chat-container { width:100%; max-width:420px; height:100dvh; background:#fff; display:flex; flex-direction:column; border-radius:10px; overflow:hidden; box-shadow:0 0 10px rgba(0,0,0,0.15); }

.chat-header { background:#075e54; color:white; padding:12px 16px; display:flex; align-items:center; gap:10px; }
.avatar-container { display:flex; flex-direction:column; align-items:center; cursor:pointer; font-size:10px; color:#e0e0e0; text-align:center; }
.chat-header img { width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid white; }
.avatar-text { margin-top:2px; }

.chat-header .info { display:flex; flex-direction:column; justify-content:center; }
.chat-header .info h3 { font-size:16px; }
.chat-header .info span { font-size:12px; color:#c9c9c9; }

#mensagens { flex:1; list-style:none; background:#e5ddd5; padding:10px; overflow-y:auto; display:flex; flex-direction:column; scroll-behavior:smooth; }
li { display:flex; align-items:flex-end; gap:6px; margin:8px 0; max-width:100%; }
.mensagem-bolha { padding:8px 12px; border-radius:10px; word-wrap:break-word; font-size:15px; line-height:1.3; max-width:80%; }
.minha-mensagem { align-self:flex-end; flex-direction:row-reverse; }
.minha-mensagem .mensagem-bolha { background:#dcf8c6; border-top-right-radius:0; }
.mensagem-outro { flex-direction:row; }
.mensagem-outro .mensagem-bolha { background:#fff; border-top-left-radius:0; }
.mensagem-outro img { width:32px; height:32px; border-radius:50%; object-fit:cover; }
li img { width:32px; height:32px; border-radius:50%; object-fit:cover; }
.bem-vindo { align-self:center; color:#666; font-style:italic; font-size:13px; margin:10px 0; }
.hora { font-size:11px; color:#999; margin-left:6px; float:right; }

form { background:#f0f0f0; display:flex; flex-direction:column; border-top:1px solid #ccc; padding:10px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); }
#nome { margin-bottom:8px; padding:10px; border:1px solid #ccc; border-radius:8px; outline:none; font-size:15px; }
.input-area { display:flex; align-items:center; gap:8px; }
#mensagem { flex:1; padding:12px 16px; border:1px solid #ccc; border-radius:22px; outline:none; font-size:15px; }
button { background:#25d366; color:white; border:none; border-radius:50%; width:45px; height:45px; cursor:pointer; font-size:18px; display:flex; justify-content:center; align-items:center; }
button:hover { background:#1ebe57; }

#mensagens::-webkit-scrollbar { width:6px; }
#mensagens::-webkit-scrollbar-thumb { background:#c1c1c1; border-radius:10px; }

@media(max-width:450px){ body{align-items:stretch} .chat-container{border-radius:0; height:100dvh} }
</style>
</head>
<body>

<div class="chat-container">
  <div class="chat-header">
    <div class="avatar-container">
      <img id="fotoHeader" src="https://cdn-icons-png.flaticon.com/512/124/124034.png" alt="Avatar" title="Clique para escolher foto">
      <span class="avatar-text">Altere sua foto</span>
    </div>
    <div class="info">
      <h3>Chat em Grupo</h3>
      <span id="status">visto por Ãºltimo Ã s --:--</span>
    </div>
  </div>

  <ul id="mensagens"></ul>

  <form id="form">
    <input id="nome" placeholder="Seu nome de usuÃ¡rio" autocomplete="off">
    <input type="file" id="fotoInput" accept="image/*" style="display:none">
    <div class="input-area">
      <input id="mensagem" placeholder="Digite uma mensagem..." autocomplete="off">
      <button type="submit">âž¤</button>
    </div>
  </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const nomeInput = document.getElementById("nome");
const fotoInput = document.getElementById("fotoInput");
const mensagemInput = document.getElementById("mensagem");
const mensagens = document.getElementById("mensagens");
const form = document.getElementById("form");
const statusSpan = document.getElementById("status");
const fotoHeader = document.getElementById("fotoHeader");

let meuNome = "";
let minhaFoto = "https://cdn-icons-png.flaticon.com/512/124/124034.png";

// --- FUNÃ‡ÃƒO PARA ATUALIZAR VISTO LOCAL ---
function atualizaVisto() {
  const agora = new Date();
  const horas = agora.getHours().toString().padStart(2,'0');
  const minutos = agora.getMinutes().toString().padStart(2,'0');
  statusSpan.textContent = `visto por Ãºltimo Ã s ${horas}:${minutos}`;
}

// --- DEFINIR NOME ---
nomeInput.addEventListener("change", ()=>{
  const nome = nomeInput.value.trim();
  if(nome && !meuNome){
    meuNome = nome;
    nomeInput.disabled = true;
    socket.emit("usuario entrou", { nome:meuNome, foto:minhaFoto });
    atualizaVisto();
  }
});

// --- ABRIR GALERIA AO CLICAR NO AVATAR ---
fotoHeader.addEventListener("click", ()=> fotoInput.click());

// --- LER IMAGEM SELECIONADA ---
fotoInput.addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    minhaFoto = reader.result;
    fotoHeader.src = minhaFoto;

    setTimeout(()=>{
      mensagemInput.focus(); // mantÃ©m teclado aberto
    }, 150);

    atualizaVisto();
  };
  reader.readAsDataURL(file);
});

// --- ENVIO DE MENSAGENS ---
function enviarMensagem(){
  const nome = nomeInput.value.trim();
  const mensagem = mensagemInput.value.trim();
  if(!nome || !mensagem) return;

  if(!meuNome){
    meuNome = nome;
    nomeInput.disabled = true;
    socket.emit("usuario entrou", { nome:meuNome, foto:minhaFoto });
    const bemVindo = document.createElement("li");
    bemVindo.textContent = `ðŸ‘‹ Bem-vindo, ${meuNome}!`;
    bemVindo.classList.add("bem-vindo");
    mensagens.appendChild(bemVindo);
  }

  socket.emit("chat message", { nome, mensagem, foto:minhaFoto });
  mensagemInput.value="";
  atualizaVisto();
}

form.addEventListener("submit", (e)=>{ e.preventDefault(); enviarMensagem(); });
mensagemInput.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); enviarMensagem(); }});
mensagemInput.addEventListener("input", atualizaVisto);

// --- RECEBER MENSAGENS ---
socket.on("chat message",(dados)=>{
  const item = document.createElement("li");
  const bolha = document.createElement("div");
  const img = document.createElement("img");

  img.src = dados.foto || "https://cdn-icons-png.flaticon.com/512/124/124034.png";
  bolha.classList.add("mensagem-bolha");

  const hora = new Date();
  const horaStr = hora.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
  bolha.innerHTML = `<strong>${dados.nome}:</strong> ${dados.mensagem} <span class="hora">${horaStr}</span>`;

  if(dados.nome===meuNome) item.classList.add("minha-mensagem");
  else item.classList.add("mensagem-outro");

  item.appendChild(img);
  item.appendChild(bolha);
  mensagens.appendChild(item);
  mensagens.scrollTop = mensagens.scrollHeight;
});

// --- ATUALIZA FOTO EM TEMPO REAL ---
socket.on("atualiza foto",(dados)=>{
  document.querySelectorAll("li").forEach(li=>{
    const strong = li.querySelector("strong");
    if(strong && strong.textContent.replace(":", "")===dados.nome){
      li.querySelector("img").src = dados.foto;
    }
  });
});
</script>

</body>
</html>
